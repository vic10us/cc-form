<!--
@license
Copyright (c) 2016 DEXS Inc. All rights reserved.
This code may only be used under the MIT style license found at LICENSE.md
-->

<link rel="import" href="../polymer/polymer.html">

<!--
`stripe-behavior`
Behavior wrapper for the Stripe library

@demo demo/index.html 
-->
<script>
  StripeBehavior = {

    properties: {
      Stripe: {
        type: Object,
      },

      publisheableKey: {
        type: String
      },

      validationResult: {
        type: String,
        notify: true
      }
    },
    
    _initStripe: function() {
      if (!!!this.Stripe)
        this.Stripe = Stripe;
      if (!!!this.Stripe.key)
        this.Stripe.setPublishableKey(this.publisheableKey);
    },

    _stripeExists: function() {
      return typeof Stripe != "undefined";
    },

    _loadStripe: function(){
      if(this._stripeExists()){
        this._initStripe();
        return;
      }

      var script = document.createElement('script');
      script.src = "https://js.stripe.com/v2/";
      document.body.appendChild(script);
      script.onload = this._initStripe.bind(this);
    },

    _stripeResponseHandler: function(status, response) {
      if (response.error) {
        if (this.debug) console.log(response.error);
        this.validationResult = response.error.message;
        this.fire('stripe-card-validation-failed', response.error);
        return;
      }
      if (this.debug) console.log(response.id);
      this.fire('stripe-card-validation-succeeded', { token: response.id });
      this.validationResult = response.id;
    },

    validate: function(e, detail) {
      try {
      this.Stripe.card.createToken({
        number: this.creditCard,
        cvc: this.cvc,
        exp: this.expiryDate
      }, this._stripeResponseHandler.bind(this));
      } catch (error) {
        this.fire('stripe-card-validation-failed', { message: 'An exception occurred', exception: error });
      }
    },

    created: function() {
      this._loadStripe();
    },

  };
</script>